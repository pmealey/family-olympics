# Subpath Deployment Configuration

This document explains how the Family Olympics application is configured to work with the `/family-olympics` base path for deployment behind a reverse proxy.

## Overview

The application is now configured to work at `https://www.aureliansystems.io/family-olympics/` when proxied through nginx or any other reverse proxy. It will also work correctly when accessed directly via CloudFront at `https://d35ibl7f7j79bh.cloudfront.net/family-olympics/`.

## Changes Made

### 1. Vite Configuration (`ui/vite.config.ts`)

Added the `base` option to tell Vite to prefix all asset paths with `/family-olympics/`:

```typescript
export default defineConfig({
  plugins: [react()],
  base: '/family-olympics/',
})
```

This ensures that:
- JavaScript bundles are loaded from `/family-olympics/assets/...`
- CSS files are loaded from `/family-olympics/assets/...`
- Static assets reference the correct paths

### 2. React Router Configuration (`ui/src/App.tsx`)

Added `basename` prop to the `BrowserRouter`:

```typescript
<Router basename="/family-olympics">
  <Routes>
    {/* routes */}
  </Routes>
</Router>
```

This ensures that:
- All route paths are prefixed with `/family-olympics`
- Navigation works correctly (e.g., `/family-olympics/schedule`)
- Links generated by React Router include the base path

### 3. CloudFront/S3 Configuration (`lib/family-olympics-stack.ts`)

Updated the deployment to place files in a subdirectory:

```typescript
new s3deploy.BucketDeployment(this, 'DeployWebsite', {
  sources: [s3deploy.Source.asset(join(__dirname, '../ui/dist'))],
  destinationBucket: websiteBucket,
  destinationKeyPrefix: 'family-olympics/',  // Files go in /family-olympics/ folder
  distribution,
  distributionPaths: ['/*'],
});
```

Updated CloudFront error responses to point to the correct index.html location:

```typescript
defaultRootObject: 'family-olympics/index.html',
errorResponses: [
  {
    httpStatus: 404,
    responseHttpStatus: 200,
    responsePagePath: '/family-olympics/index.html',
    ttl: cdk.Duration.minutes(5),
  },
  // ...
]
```

## Local Development

### Running Locally with Base Path

To test the application locally with the `/family-olympics` base path:

```bash
cd ui
npm run dev
```

Then access the application at:
```
http://localhost:5173/family-olympics/
```

**Important:** You must include the trailing slash or navigate to `/family-olympics/` - just `http://localhost:5173` will show a blank page.

### Running Locally Without Base Path (Optional)

If you want to develop without the base path, you can temporarily modify `vite.config.ts`:

```typescript
export default defineConfig({
  plugins: [react()],
  base: '/',  // Temporarily change for local dev
})
```

And `App.tsx`:

```typescript
<Router basename="/">  {/* Temporarily change for local dev */}
```

**Remember to change these back before deploying!**

## Production Deployment

### Build the Application

**IMPORTANT:** You must rebuild the UI after making the configuration changes!

```bash
cd ui
npm run build
```

This creates a `dist` folder with all assets correctly prefixed with `/family-olympics/`.

**Verify the build:** Check `ui/dist/index.html` and ensure the script and link tags reference `/family-olympics/assets/` not just `/assets/`:

```html
<script type="module" crossorigin src="/family-olympics/assets/index-xxx.js"></script>
<link rel="stylesheet" crossorigin href="/family-olympics/assets/index-xxx.css">
```

If they don't have the `/family-olympics/` prefix, the `base` setting in `vite.config.ts` wasn't applied correctly.

### Deploy to AWS

```bash
cd ..
npm run build
cdk deploy
```

The CDK will:
1. Upload files to S3 in the `family-olympics/` folder
2. Configure CloudFront to serve from that path
3. Invalidate the CloudFront cache

**Quick Deploy Command (from project root):**
```bash
cd ui && npm run build && cd .. && npm run build && cdk deploy
```

### Access the Application

After deployment, you can access the application at:

- **Direct CloudFront:** `https://d35ibl7f7j79bh.cloudfront.net/family-olympics/`
- **Via Proxy:** `https://my-web-site.com/family-olympics/`

## Nginx Proxy Configuration

Your nginx configuration should look something like this:

```nginx
location /family-olympics/ {
    proxy_pass https://d35ibl7f7j79bh.cloudfront.net/family-olympics/;
    proxy_set_header Host d35ibl7f7j79bh.cloudfront.net;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Handle redirects properly
    proxy_redirect https://d35ibl7f7j79bh.cloudfront.net/family-olympics/ /family-olympics/;
}
```

**Important Notes:**
- The trailing slash in `location /family-olympics/` is important
- The trailing slash in `proxy_pass` is important
- Make sure to include the `/family-olympics/` path in the proxy_pass URL

## Routes and Navigation

All routes now work with the base path:

- Home: `/family-olympics/`
- Schedule: `/family-olympics/schedule`
- Event Detail: `/family-olympics/events/:eventId`
- Judge Login: `/family-olympics/judge`
- Judge Events: `/family-olympics/judge/events`
- Judge Score Entry: `/family-olympics/judge/events/:eventId/score`
- Admin: `/family-olympics/admin`

## Troubleshooting

### Assets Returning HTML Instead of JS/CSS

**Problem:** Accessing `https://d35ibl7f7j79bh.cloudfront.net/assets/index-xxx.js` returns HTML instead of JavaScript, or assets are referenced as `/assets/` instead of `/family-olympics/assets/`

**Root Cause:** Either:
1. The UI was built BEFORE the `base: '/family-olympics/'` configuration was added to `vite.config.ts`
2. There's an old compiled `vite.config.js` file without the base configuration

**Solution:**
1. Ensure `base: '/family-olympics/'` is in `ui/vite.config.ts`
2. **Delete compiled config files:** 
   ```bash
   rm ui/vite.config.js ui/vite.config.d.ts
   ```
   (or manually delete `vite.config.js` and `vite.config.d.ts` from the `ui` folder)
3. **Rebuild the UI:** `cd ui && npm run build`
4. Verify `ui/dist/index.html` contains `/family-olympics/assets/` in script/link tags (lines 20-21)
5. Build CDK: `cd .. && npm run build`
6. Redeploy: `cdk deploy`

### Assets Not Loading

**Problem:** JavaScript/CSS files return 404 errors

**Solution:** 
- Ensure you've rebuilt the UI AFTER adding the base path: `cd ui && npm run build`
- Verify the `base` setting in `vite.config.ts` is `/family-olympics/`
- Check that files are deployed to the correct S3 path
- Verify the built `index.html` references `/family-olympics/assets/` not `/assets/`

### Routes Not Working

**Problem:** Navigation to `/family-olympics/schedule` shows 404

**Solution:**
- Verify `basename="/family-olympics"` is set in `App.tsx`
- Check CloudFront error responses are configured correctly
- For nginx proxy, ensure the location block includes the trailing slash

### Blank Page on Load

**Problem:** Accessing the site shows a blank page

**Solution:**
- Check browser console for errors
- Verify you're accessing `/family-olympics/` with the trailing slash
- Ensure the `index.html` is at the correct path in S3

### Local Development Issues

**Problem:** `http://localhost:5173` shows blank page

**Solution:**
- Navigate to `http://localhost:5173/family-olympics/` instead
- The app is configured to run at the subpath, not the root

## Reverting to Root Path

If you need to deploy at the root path instead of a subpath:

1. **Update `ui/vite.config.ts`:**
   ```typescript
   base: '/',
   ```

2. **Update `ui/src/App.tsx`:**
   ```typescript
   <Router basename="/">
   ```

3. **Update `lib/family-olympics-stack.ts`:**
   - Remove `destinationKeyPrefix: 'family-olympics/',`
   - Change `defaultRootObject: 'index.html',`
   - Change error response paths to `/index.html`

4. **Rebuild and redeploy:**
   ```bash
   cd ui && npm run build
   cd .. && npm run build && cdk deploy
   ```

## Testing Checklist

After deployment, verify:

- [ ] Home page loads at `/family-olympics/`
- [ ] All assets (JS, CSS) load correctly
- [ ] Navigation to `/family-olympics/schedule` works
- [ ] Direct navigation to `/family-olympics/events/[id]` works
- [ ] Browser refresh on any route maintains the page
- [ ] Judge login flow works
- [ ] Admin page loads
- [ ] All images and static assets display correctly

## Additional Notes

- The `base` path must have leading and trailing slashes: `/family-olympics/`
- The `basename` in React Router should have a leading slash but no trailing slash: `/family-olympics`
- CloudFront paths should have a leading slash: `/family-olympics/index.html`
- S3 key prefixes should have a trailing slash but no leading slash: `family-olympics/`

